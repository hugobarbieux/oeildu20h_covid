---
title: "L'Oeil du 20h"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
output: html_document
---
## __Etat des lieux de la vaccination en France__

__Ce "markdown" est dedie a la datavisualisation des donnees sur la vacination contre le COVID-19.__

Le but : voir si la vaccination privilegie un groupe de personnes et si les departements d'Outre-mer sont laisses de cote.

```{r include=FALSE}
# Packages necessaires
#install.packages("tidyverse")
#install.packages("lubridate")
#install.packages("zoo")
#install.packages("reshape2")
#install.packages("viridis")
#install.packages("timetk")
library(tidyverse)
library(lubridate)
library(zoo)
library(reshape2)
library(viridis)
library(timetk)
```

```{r include=FALSE}
# Importer les libraries pour construire un graphique

#This line of code installs the pacman page if you do not have it installed - if you do, it simply loads the package
#if(!require(pacman))install.packages("pacman")

pacman::p_load('dplyr', 'tidyr', 'gapminder',
               'ggplot2',  'ggalt',
               'forcats', 'R.utils', 'png', 
               'grid', 'ggpubr', 'scales',
               'bbplot')

#install.packages(extrafont)
library(extrafont)
```

```{r include=FALSE}
# Liens de telechargement vers les donnees de data.gouv.fr

#nombre quotidien de residents en EHPAD ayant reçu au moins une dose ou deux doses, par date d'injection
url1 <- "https://www.data.gouv.fr/fr/datasets/r/72d3b91e-ef24-4c91-a3c3-52b72d418000"
#nombre de residents en EHPAD ayant reçu au moins une dose ou deux doses ainsi que la couverture vaccinale, arrete a la derniere date disponible
url2 <- "https://www.data.gouv.fr/fr/datasets/r/104f3ab1-de0f-41c5-9bd8-edab9926882c"
#nombre quotidien de personnes ayant reçu au moins une dose, par classes d'age, et par date d'injection
url3 <- "https://www.data.gouv.fr/fr/datasets/r/54dd5f8d-1e2e-4ccb-8fb8-eac68245befd"
#nombre de personnes ayant reçu au moins une dose ou deux doses, par classes d'age, arrete a la derniere date disponible
url4 <- "https://www.data.gouv.fr/fr/datasets/r/dc103057-d933-4e4b-bdbf-36d312af9ca9"
#nombre de personnes ayant re?u au moins une dose ou deux doses, par classes d'age, arrete a la derniere date disponible, echelle regionale
url5 <- "https://www.data.gouv.fr/fr/datasets/r/2dadbaa7-02ae-43df-92bb-53a82e790cb2"
#nombre de residents en EHPAD ayant re?u au moins une dose ou deux doses ainsi que la couverture vaccinale, arrete la derniere date disponible, echelle regionale
url6 <-"https://www.data.gouv.fr/fr/datasets/r/5cb5a964-a8f7-4111-b527-1a2d48dee3d4"
#nombre de personnes testées et le nombre de personnes déclarées positives par sexe et classe d'âge
url7 <- "https://www.data.gouv.fr/fr/datasets/r/dd0de5d9-b5a5-4503-930a-7b08dc0adc7c"
#nombre de personnes ayant re?u au moins une dose, par classe d'ages, arrete a la derniere date disponible, echelle departementale
url8 <- "https://www.data.gouv.fr/fr/datasets/r/de4b356b-8cd9-4b9a-8878-459a62646107"
#nombre de résidents en EHPAD ayant reçu au moins une dose ou deux doses ainsi que la couverture vaccinale, echelle departementale
url9 <- "https://www.data.gouv.fr/fr/datasets/r/1cbfd282-e882-479d-afcc-958f09f617ec"
#livraisons departementales réalisées et prévisionnelles par semaine, en UCD (flacons) et doses comptabilisées comme la somme des différents flux départementaux
url10 <- "https://www.data.gouv.fr/fr/datasets/r/d9ad34ee-2d05-4f40-965b-9ba40a7d5f83"
#prises de rendez-vous par centre de vaccination
url11 <- "https://www.data.gouv.fr/fr/datasets/r/dc2fd531-2314-44bb-b0a9-39e621e4b12c"
#lieux de vaccination COVID-19
url12 <- "https://www.data.gouv.fr/fr/datasets/r/5cb21a85-b0b0-4a65-a249-806a040ec372"
```

```{r include=FALSE}
# Lire les donnees de data.gouv
vacsi_res_fra <- read.csv(url1)
vacsi_res_tot_fra <- read.csv(url2)
vacsi_a_fra <- read.csv(url3) %>%
  arrange(clage_vacsi)
vacsi_tot_a_fra <- read.csv(url4)
vacsi_tot_a_reg <- read.csv(url5) # colClasses = c(reg = "character"))
vacsi_res_tot_reg_fra <- read.csv(url6)
sp_pos_quot_fra <- read.csv(url7, sep = ";", colClasses = c(cl_age90 = "character"))
vacsi_tot_a_dep <- read.csv(url8)
vacsi_res_tot_dep <- read.csv(url9)
livraisons_realisees_cumul_dep <- read.csv(url10)
prise_rdv_par_centre <- read.csv(url11)
centres_vaccination <- read.csv(url12, sep = ";")
```

_Attention : la seconde dose ne figure pas toujours dans data.gouv.fr ! Il faut retrouver ces donnees sur Geodes et les ajouter au tableau._

Geodes propose le total des secondes injections par jour. Recuperer ces donnees se fait principalement a la main dans un tableau a part.

```{r include=FALSE}
## CALCUL NBR CENTRES VAX PAR DEP

#centres_vax_dep <- merge(x = centres_vaccination, y = prise_rdv_par_centre[ , c("id_centre", "departement")],
#                         by.x=c("gid"),by.y=c("id_centre"), all.x=TRUE)

#centres_vax_dep <- centres_vax_dep %>%
#  group_by(departement) %>%
#  summarise(count = n_distinct(gid))

#centres_vaccination$com_cp <- substr(centres_vaccination$com_cp,1,nchar(centres_vaccination$com_cp)-3)

#centres_vax_dep <- centres_vaccination %>%
#  group_by(com_cp) %>%
#  summarise(count = n_distinct(gid))

#write.csv(centres_vax_dep, "centres_vax_dep.csv")

centres_vax_dep <- read.csv("centres_vax_dep.csv")
```

```{r include=FALSE}
## TELECHARGEMENT DE DONNEES COMPLEMENTAIRES
# Donnees sur les soignants par departement, source : DGS
soignants_df <- read.csv("soignants_par_departement.csv") %>%
  select(dep = c(1), c(2), c(3))
```

```{r include=FALSE}
## TELECHARGEMENT DE DONNEES COMPLEMENTAIRES
# Donnes sur les deuxiemes doses, niveau national, par tranche d'ages

# Attention : "vacsi_a_fra" (vaccination age quotidien) ne mentionne pas la seconde dose !
# Il faut d'abord retrouver ces donnees sur Geodes et les ajouter au tableau - Geodes propose le total des secondes injections par jour.

# Creer un variable "vacsi_a_fra_dose2" et y importer les donnees de seconde vaccination par jour de Geodes
vacsi_a_fra_dose2 <- read.csv("geodes.csv", header = T) %>%
  pivot_longer(c(2:12), names_to ="clage_vacsi") %>% # passer du format wide au format long
  arrange(clage_vacsi)

# Enlever les X qui venaient du nom des colonnes
vacsi_a_fra_dose2$clage_vacsi <- stringr::str_replace(vacsi_a_fra_dose2$clage_vacsi, "X", "") %>%
  as.numeric(vacsi_a_fra_dose2$clage_vacsi)

# Combiner aux data "vacsi_a_fra" dans une nouvelle variable appelee "vacsi_a_fra_2doses"
vacsi_a_fra_2doses <- left_join(vacsi_a_fra, vacsi_a_fra_dose2, by=c("jour"="jour", "clage_vacsi"="clage_vacsi")) %>%
  rename(n_cum_dose2 = value)

# Calculer le nombre journalier de secondes vaccinations
vacsi_a_fra_2doses <- vacsi_a_fra_2doses %>%
  mutate(jour = ymd(jour)) %>%
  arrange(clage_vacsi, jour) %>%
  mutate(n_dose2 = n_cum_dose2-lag(n_cum_dose2))

vacsi_a_fra_2doses[vacsi_a_fra_2doses<0] <- 0 # petit truc pour regler un bug avec la fonction lag

```

```{r include=FALSE}
## TELECHARGEMENT DE DONNEES COMPLEMENTAIRES
# Donnees sur les deuxiemes doses, par departement (recoltees sur Geodes)

vacsi_tot_a_dep_dose2 <- read.csv("geodes_2.csv", header = T, encoding = "UTF-8", skip = 3) %>%
  select(dep = c(1), `0`=c(3), `24`=c(4), `29`=c(5), `39`=c(5), `49`=c(7),
         `59`=c(8), `64`=c(9), `69`=c(10), `74`=c(11), `79`=c(12),`80`=c(13)) %>%
           na.omit(vacsi_tot_a_dep_dose2) %>%
  pivot_longer(c(2:12), names_to = "clage_vacsi") %>% # passer du format wide au format long
  arrange(dep)

vacsi_tot_a_dep_dose2$clage_vacsi <- as.numeric(vacsi_tot_a_dep_dose2$clage_vacsi)

# Lier ces donnees aux donnees de vaccinations doses 1 par département (vacsi_tot_a_dep) dans une nouvelle variable

vacsi_a_dep_2doses <- left_join(vacsi_tot_a_dep, vacsi_tot_a_dep_dose2, by=c("dep"="dep", "clage_vacsi"="clage_vacsi")) %>%
  rename(n_cum_dose2 = value)

```

```{r include=FALSE}
## TELECHARGEMENT DE DONNEES COMPLEMENTAIRES  - Population par region
# Preparation des donnees pour des graphique comparant l'avancement de la vaccination par region et par tranche d'ages, en pourcentage de la population concernee

# Importer les donnees INSEE avec la population par region et le code region

reg_pop <- read.csv("population_regions.csv",
                    sep = ",",
                    header = TRUE,
                    encoding = "UTF-8",
                    skip = 4) %>%
  select(noms = c(1), reg = c(2), `40_59` = c(5), `60_74` = c(6), `75_plus` = c(7), pop_total = Total) %>%
  na.omit(reg_pop)

```

```{r include=FALSE}
## TELECHARGEMENT DE DONNEES COMPLEMENTAIRES - Population par departement
# Preparation des donnees pour des graphique comparant l'avancement de la vaccination par departement

# Importer les donnees INSEE avec la population par departement et le code departement

dep_pop <- read.csv("population_departements.csv",
                    header = TRUE,
                    encoding = "UTF-8",
                    skip = 4) %>%
  select(dep = c(1), nom = c(2), `40_59` = c(5), `60_74` = c(6), `75_plus` = c(7), pop_total = Total) %>%
  na.omit(dep_pop)

```

```{r include=FALSE}
## TRI DONNEES NATIONALES - NOUVELLES TRANCHES D'AGES

# Maintenant nous avons une base de donnees "vacsi_a_fra_2doses" qui comprend les deux injections par jour et par tranche d'ages.
# Il faut faire correspondre les tranches d'age de data.gouv.fr avec les tranches de l'INSEE
# Donc assimiler les tranches 49 et 59, 69 et 74, 79 et 80 en créant d'abord 3 "sous-dataframes".

dt1 <- vacsi_a_fra_2doses %>%
  filter(clage_vacsi %in% c(49, 59)) %>%
  mutate(jour = ymd(jour)) %>%
  group_by(jour) %>%
  summarise(cum_dose1 = sum(n_cum_dose1), cum_dose2 = sum(n_cum_dose2))

clagedt1 <- c("49_59")

dt1$clage_vacsi <- clagedt1

dt2 <- vacsi_a_fra_2doses %>%
  filter(clage_vacsi %in% c(69, 74)) %>%
  mutate(jour = ymd(jour)) %>%
  group_by(jour) %>%
  summarise(cum_dose1 = sum(n_cum_dose1), cum_dose2 = sum(n_cum_dose2))

clagedt2 <- c("69_74")

dt2$clage_vacsi <- clagedt2

dt3 <- vacsi_a_fra_2doses %>%
  filter(clage_vacsi %in% c(79, 80)) %>%
  group_by(jour) %>%
  summarise(cum_dose1 = sum(n_cum_dose1), cum_dose2 = sum(n_cum_dose2))

clagedt3 <- c("79_80")

dt3$clage_vacsi <- clagedt3

# Avant de reassembler "vacsi_a_fra_2doses" avec les nouvelles classes d'ages, transformer les donnees ehpad pour qu'elles soient compatibles avec "vacsi_a_fra_2doses"

# Netoyage des donnees ehpad :
# Inventer/ajouter un nouvel index pour les ehpad
ehpad_code_age <- c("FR99")
# Mettre cet index dans une nouvelle colonne
vacsi_res_fra$clage_vacsi <- ehpad_code_age
# Garder les colonnes utiles pour fusionner toutes les dataframes
vacsi_res_fra <- vacsi_res_fra [ c(2,5,6,7) ]
# Renommer les colonnes pour correspondre avec les autres dt
names(vacsi_res_fra)[names(vacsi_res_fra) == "res_vac_cum_dose1"] <- "cum_dose1"
names(vacsi_res_fra)[names(vacsi_res_fra) == "res_vac_cum_dose2"] <- "cum_dose2"

vacsi_res_fra <- vacsi_res_fra %>%
  mutate(jour = ymd(jour))

#Assembler les donnees
vacsi_a_fra_2doses <- rbind(dt1, dt2, dt3, vacsi_res_fra)
```

```{r include=FALSE}
## TRI DONNEES REGIONALES - NOUVELLES TRANCHES D'AGES

# Donnees pour la population totale (indice 0) dans les data de data.gouv
# Assembler avec les donnees INSEE

df2 <- vacsi_tot_a_reg %>%
  filter(clage_vacsi == 0)

df2 <-left_join(df2, reg_pop, by = "reg") %>%
  na.omit(df2) %>%
  mutate(`%_population_dose1` = round(n_tot_dose1/(as.numeric(pop_total))*100, digits = 2)) %>%
  mutate(`%_population_dose2` = round(n_tot_dose2/(as.numeric(pop_total))*100, digits = 2))

df2 <- df2[ c(8, 13, 14) ]

df2 <- melt(df2,  id.vars = "noms", variable.name = "series")

###
# Donnees pour la tranche d'ages 40-59 ans comme classes par l'INSEE

# Les tranches d'ages sont decoupees differemment sur data.gouv
# Il faut rassembler les classes d'age 49 et 59, 69 et74, 79 et 80 pour correspondre avec le classement INSEE

# 40-59 ans

df3 <- vacsi_tot_a_reg %>%
  filter(clage_vacsi %in% c(49, 59)) %>%
  group_by(reg) %>%
  summarise(n_tot_dose1 = sum(n_tot_dose1), n_tot_dose2 = sum(n_tot_dose2))

df3 <-left_join(df3, reg_pop, by = "reg") %>%
  na.omit(df3) %>%
  mutate(`%_population_dose1` = round(n_tot_dose1/(as.numeric(`40_59`))*100, digits = 2)) %>%
  mutate(`%_population_dose2` = round(n_tot_dose2/(as.numeric(`40_59`))*100, digits = 2))

df3 <- df3[ c(4, 9, 10) ]

df3 <- melt(df3,  id.vars = "noms", variable.name = "series")

###
# 60-74 ans

df4 <- vacsi_tot_a_reg %>%
  filter(clage_vacsi %in% c(64, 69, 74)) %>%
  group_by(reg) %>%
  summarise(n_tot_dose1 = sum(n_tot_dose1), n_tot_dose2 = sum(n_tot_dose2))

df4 <-left_join(df4, reg_pop, by = "reg") %>%
  na.omit(df4) %>%
  mutate(`%_population_dose1` = round(n_tot_dose1/(as.numeric(`60_74`))*100, digits = 2)) %>%
  mutate(`%_population_dose2` = round(n_tot_dose2/(as.numeric(`60_74`))*100, digits = 2))

df4 <- df4[ c(4, 9, 10) ]

df4 <- melt(df4,  id.vars = "noms", variable.name = "series")

###
# 75 ans et plus ans

df5 <- vacsi_tot_a_reg %>%
  filter(clage_vacsi %in% c(79, 80)) %>%
  group_by(reg) %>%
  summarise(n_tot_dose1 = sum(n_tot_dose1), n_tot_dose2 = sum(n_tot_dose2))

df5 <-left_join(df5, reg_pop, by = "reg") %>%
  na.omit(df5) %>%
  mutate(`%_population_dose1` = round(n_tot_dose1/(as.numeric(`75_plus`))*100, digits = 2)) %>%
  mutate(`%_population_dose2` = round(n_tot_dose2/(as.numeric(`75_plus`))*100, digits = 2))

df5 <- df5[ c(4, 9, 10) ]

df5 <- melt(df5,  id.vars = "noms", variable.name = "series")

###
# EHPAD

df6 <- vacsi_res_tot_reg_fra %>%
  inner_join(reg_pop, by = "reg")

df6 <- df6[ c(7,5,6) ]

df6 <- melt(df6,  id.vars = "noms", variable.name = "series")
```

```{r include=FALSE}
## TRI DONNEES DEPARTEMENTALES - NOUVELLES TRANCHES D'AGES

# Maintenant nous avons une base de donnees "vacsi_a_dep_2doses" qui comprend les deux injections par departement et par tranche d'ages.
# Il faut faire correspondre les tranches d'age de data.gouv.fr avec les tranches de l'INSEE
# Donc assimiler les tranches 49 et 59, 69 et 74, 79 et 80

dt9 <- vacsi_a_dep_2doses %>%
  filter(clage_vacsi %in% c(49, 59)) %>% #filtrer par les deux categories d'ages
  group_by(dep) %>%
  summarise(tot_dose1 = sum(n_tot_dose1), tot_dose2 = sum(n_cum_dose2))

clagedt9 <- c("49_59") #creer un nouvel index de classe d'age dans un vecteur

dt9$clage_vacsi <- clagedt9 #associer la valeur de ce vecteur a une nouvelle colonne nommee "clage_vacsi"

dt9 <-left_join(dt9, dep_pop, by = "dep") %>% #joindre les donnees de vaccination aux donnees de population
  na.omit(dt9) %>%
  mutate(`%_population_dose1` = round(tot_dose1/as.numeric((`40_59`))*100, digits = 2)) %>%
  mutate(`%_population_dose2` = round(tot_dose2/as.numeric((`40_59`))*100, digits = 2))

dt9 <- dt9[ c(5, 10, 11) ]

dt9 <- melt(dt9,  id.vars = "nom", variable.name = "series")

###

dt10 <- vacsi_a_dep_2doses %>%
  filter(clage_vacsi %in% c(64, 69, 74)) %>%
  group_by(dep) %>%
  summarise(tot_dose1 = sum(n_tot_dose1), tot_dose2 = sum(n_cum_dose2))

clagedt10 <- c("60_74")

dt10$clage_vacsi <- clagedt10

dt10 <-left_join(dt10, dep_pop, by = "dep") %>% #joindre les donnees de vaccination aux donnees de population
  na.omit(dt10) %>%
  mutate(`%_population_dose1` = round(tot_dose1/(as.numeric(`60_74`))*100, digits = 2)) %>%
  mutate(`%_population_dose2` = round(tot_dose2/(as.numeric(`60_74`))*100, digits = 2))

dt10 <- dt10[ c(5, 10, 11) ]

dt10 <- melt(dt10,  id.vars = "nom", variable.name = "series")

###

dt11 <- vacsi_a_dep_2doses %>%
  filter(clage_vacsi %in% c(79, 80)) %>%
  group_by(dep) %>%
  summarise(tot_dose1 = sum(n_tot_dose1), tot_dose2 = sum(n_cum_dose2))

clagedt11 <- c("75_plus")

dt11$clage_vacsi <- clagedt11

dt11 <-left_join(dt11, dep_pop, by = "dep") %>% #joindre les donnees de vaccination aux donnees de population
  na.omit(dt11) %>%
  mutate(`%_population_dose1` = round(tot_dose1/(as.numeric(`75_plus`))*100, digits = 2)) %>%
  mutate(`%_population_dose2` = round(tot_dose2/(as.numeric(`75_plus`))*100, digits = 2))

dt11 <- dt11[ c(5, 10, 11) ]

dt11 <- melt(dt11,  id.vars = "nom", variable.name = "series")

# Trier les donnees ehpad par departement "vacsi_res_tot_dep" pour qu'elles soient compatibles avec "vacsi_a_dep_2doses"

# Inventer/ajouter un nouvel index pour les ehpad
ehpad_code_age <- c("FR99")
# Mettre cet index dans une nouvelle colonne
vacsi_res_tot_dep$clage_vacsi <- ehpad_code_age

vacsi_res_tot_dep <-left_join(vacsi_res_tot_dep, dep_pop, by = "dep") %>%
  na.omit(vacsi_res_tot_dep)
# Garder les colonnes utiles (couverture vaccinale) pour un graphique proportionnel
vacsi_res_tot_dep <- vacsi_res_tot_dep [ c(8,5,6) ]

vacsi_res_tot_dep <- melt(vacsi_res_tot_dep,  id.vars = "nom", variable.name = "series")
```


## __Livraisons de vaccins - Ou sont les doses ?__


```{r include=FALSE}
library(tmap)
library(sp)
library(sf)

# Importer carte des departements .shp (IGN)
FR_departements <- st_read("./departements/DEPARTEMENT.shp") %>%
  select(dep = CODE_DEPT, X_CENTROID, Y_CENTROID) %>%
  inner_join(dep_pop, by = "dep")

#plot(st_geometry(FR_departements))
#View(FR_departements)

# Faire la somme cumulée des vaccins reçus et mettre le resulata dans une nouvelle variable
livraisonsdf <- livraisons_realisees_cumul_dep %>%
  group_by(code_departement) %>%
  filter(date == max(date)) %>%
  group_by(code_departement) %>%
  summarise(nb_doses_total = sum(nb_doses))

names(livraisonsdf)[1] <- "dep"

# Lier les livraisons aux donnees geo (dans une autre variable pour un graphique)

data_map <- FR_departements %>%
  left_join(livraisonsdf, by = "dep") %>%
  arrange(desc(nb_doses_total)) %>%
  mutate(text = paste0(nom, " : ", nb_doses_total, " doses"))

```

### __Repartition des doses de vaccins pour 100 habitants elegibles a la vaccination__

#### Tous vaccins confondus

```{r include=FALSE}
# Lier les donnes de de livraisons aux donnees soignants
public_prior <- soignants_df %>%
  left_join(dep_pop, by = "dep")%>%
  mutate(public = (`75_plus` + soignants_prioritaires)) %>%
  left_join(livraisonsdf, by = "dep") %>%
  mutate(ratio_prior = round((nb_doses_total/public)*100, digits = 0)) %>%
  mutate(text = paste0(nom, " : ", ratio_prior, " doses pour 100 habitants prioritaires"))

map_publicprior_df <- FR_departements %>%
  left_join(public_prior, by = "dep")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
tmap_mode("view")

map_france_prior <- tm_shape(map_publicprior_df) +
  tm_polygons(id = "text",
              col = "#eeeeee",
              alpha = 0.3,
              border.col = "#e6e6e6") +
  tm_credits("Source : data.gouv.fr",
             col = "grey10",
             position = c("right", "bottom")) +
  tm_layout("Doses livrées - total",
            title.size = 1.8,
            bg.color="#e6e6e6",
            legend.title.size=1.2,
            fontfamily = "Brown",
            legend.position = c("left", "bottom"),
            legend.format = c(text.align = "right",
                              text.separator = "-"),
            outer.margins=c(0,0,.05,0),
            inner.margins=c(0,.02,.02,.02),
            asp=0,
            frame = FALSE) +
  tm_bubbles(id = "text",
             size = "ratio_prior",
             col = "ratio_prior",
             alpha = 0.8, border.col = "white",
             border.alpha=0, palette = "plasma",
             breaks=c(6000, 10000, 25000, 50000, 75000, 100000, 120000, 140000),
             style="equal",
             title.col="/ 100 habitants",
             legend.size.show = FALSE)

map_france_prior
```

#### Seulement Pfizer

```{r include=FALSE}
livraisons_pfizer_dep <- livraisons_realisees_cumul_dep %>%
  filter(type_de_vaccin == "Pfizer") %>%
  group_by(code_departement) %>%
  filter(date == max(date)) %>%
  group_by(code_departement) %>%
  summarise(nb_doses_total = sum(nb_doses))

names(livraisons_pfizer_dep)[1] <- "dep"


data_map_pfizer <- FR_departements %>%
  left_join(livraisons_pfizer_dep, by = "dep") %>%
  mutate(ratio_pfizer = round((nb_doses_total/pop_total)*100, digits = 0)) %>%
  arrange(desc(nb_doses_total)) %>%
  mutate(text = paste0(nom, " : ", ratio_pfizer, " doses Pfizer/100 hab."))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
map_france_pfizer <- tm_shape(data_map_pfizer) +
  tm_polygons(id = "text",
              col = "#eeeeee",
              alpha = 0.3,
              border.col = "#e6e6e6") +
  tm_credits("Source : data.gouv.fr",
             col = "grey10",
             position = c("right", "bottom")) +
  tm_layout("Doses livrées - total",
            title.size = 1.8,
            bg.color="#e6e6e6",
            legend.title.size=1.2,
            fontfamily = "Brown",
            legend.position = c("left", "bottom"),
            legend.format = c(text.align = "right",
                              text.separator = "-"),
            outer.margins=c(0,0,.05,0),
            inner.margins=c(0,.02,.02,.02),
            asp=0,
            frame = FALSE) +
  tm_bubbles(id = "text",
             size = "ratio_pfizer",
             col = "ratio_pfizer",
             alpha = 0.8, border.col = "white",
             border.alpha=0, palette = "plasma",
             breaks=c(6000, 10000, 25000, 50000, 75000, 100000, 120000, 140000),
             style="equal",
             title.col="/ 100 habitants",
             legend.size.show = FALSE)

map_france_pfizer
```


## __Nombre de centres de vaccination par 100 000 habitants__

```{r include=FALSE}
centres_vax_map_df <- FR_departements %>%
  inner_join(soignants_df, by = "dep") %>%
  inner_join(centres_vax_dep, by = "dep") %>%
  mutate(ratio_centres = round((nb_centres_vax/pop_total)*100000, digits = 0)) %>%
  mutate(text = paste0(nom, " : ", ratio_centres, " centres pour 100k habitants"))
  
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
map_france_prior <- tm_shape(centres_vax_map_df) +
  tm_polygons(id = "text",
              col = "#eeeeee",
              alpha = 0.3,
              border.col = "#e6e6e6") +
  tm_credits("Source : data.gouv.fr",
             col = "grey10",
             position = c("right", "bottom")) +
  tm_layout("Nombre de centres de vaccination par 100 000 habitants",
            title.size = 1.8,
            bg.color="#e6e6e6",
            legend.title.size=1.2,
            fontfamily = "Brown",
            legend.position = c("left", "bottom"),
            legend.format = c(text.align = "right",
                              text.separator = "-"),
            outer.margins=c(0,0,.05,0),
            inner.margins=c(0,.02,.02,.02),
            asp=0,
            frame = FALSE) +
  tm_bubbles(id = "text",
             size = "ratio_centres",
             col = "ratio_centres",
             alpha = 0.8, border.col = "white",
             border.alpha=0, palette = "plasma",
             breaks=c(6000, 10000, 25000, 50000, 75000, 100000, 120000, 140000),
             style="equal",
             title.col="/ 100k hab.",
             legend.size.show = FALSE)

map_france_prior
```


### __Chiffres cumules de livraisons__

##### En valeurs absolues - tous vaccins confondus

```{r echo=FALSE, message=FALSE, warning=FALSE}
map_france <- tm_shape(data_map) +
  tm_polygons(id = "text",
              col = "#eeeeee",
              alpha = 0.3,
              border.col = "#e6e6e6") +
  tm_credits("Source : data.gouv.fr",
             col = "grey10",
             position = c("right", "bottom")) +
  tm_layout("Doses livrées - total",
            title.size = 1.8,
            bg.color="#e6e6e6",
            legend.title.size=1.2,
            fontfamily = "Brown",
            legend.position = c("left", "bottom"),
            legend.format = c(text.align = "right",
                              text.separator = "-"),
            outer.margins=c(0,0,.05,0),
            inner.margins=c(0,.02,.02,.02),
            asp=0,
            frame = FALSE) +
  tm_bubbles(id = "text",
             size = "nb_doses_total",
             col = "nb_doses_total",
             alpha = 0.8, border.col = "white",
             border.alpha=0, palette = "plasma",
             breaks=c(6000, 10000, 25000, 50000, 75000, 100000, 120000, 140000),
             style="equal",
             title.col="Nombre de doses",
             legend.size.show = FALSE)
map_france
```


### __Chiffres de livraisons, pour 100 habitants__

####  Tous vaccins confondus

```{r include=FALSE}
# Calcul du nombres de doses livrees par 100k habitants
data_map2 <- FR_departements %>%
  left_join(livraisonsdf, by = "dep") %>%
  arrange(desc(nb_doses_total)) %>%
  mutate(doses_par_habitant = round((nb_doses_total/pop_total)*100, digits = 2)) %>%
  mutate(text = paste0(nom, " : ", doses_par_habitant, " doses/100 hab.")) %>%
  arrange(desc(doses_par_habitant))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
map_france2 <- tm_shape(data_map2) +
  tm_polygons(id = "text", col = "#eeeeee",
              alpha = 0.3,
              border.col = "#e6e6e6") +
  tm_credits("Source : data.gouv.fr",
             col = "grey10",
             position = c("right", "bottom")) +
  tm_layout("Doses livrées, pour 100 hab.",
            title.size = 1.8,
            bg.color="#e6e6e6",
            legend.title.size=1.2,
            fontfamily = "Brown",
            legend.position = c("left", "bottom"),
            legend.format = c(text.align = "right",
                              text.separator = "-"),
            outer.margins=c(0,0,.05,0),
            inner.margins=c(0,.02,.02,.02),
            asp=0,
            frame = FALSE) +
  tm_bubbles(id = "text",
             size = "doses_par_habitant",
             col = "doses_par_habitant",
             alpha = 0.8,
             border.col = "white",
             border.alpha=0,
             palette = "plasma",
             breaks=c(400, 1000, 2000, 5000, 7500, 10000, 12000),
             style="equal",
             title.col="/ 100 hab.",
             legend.size.show = FALSE)
map_france2
```


```{r include=FALSE}
#library(geojsonio)
#library(rgeos)
#library(broom)
#library(rgdal)

#Load basic background map
#dpt_map <- geojson_read("https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements.geojson", what = "sp")

#Create SpatialPointsDataFrame to export via writeOGR
#centr <- gCentroid(dpt_map, byid = TRUE)
#centr <- SpatialPointsDataFrame(centr, data = dpt_map@data)

#writeOGR(centr, "france_dpt_centroids.geojson", layer = "centroid", driver = "GeoJSON")

#centroids = geojson_read("france_dpt_centroids.geojson", what = "sp") %>% as.data.frame

#Fortify the data AND keep trace of the departement code!
#dpt_fortified <- tidy(dpt_map, region = "code")

# Now I can plot this shape using the geom_polygon() function
#p = dpt_fortified %>%
#  ggplot() +
#  geom_polygon(aes(x = long, y = lat, group = group), fill="grey", color="white") +
#  theme_void() +
#  coord_map()

# Faire la somme cumulée des vaccins reçus et mettre le resulata dans une nouvelle variable
#livraisonsdf <- livraisons_realisees_cumul_dep %>%
#  group_by(code_departement) %>%
#  filter(date == max(date)) %>%
#  group_by(code_departement) %>%
#  summarise(nb_doses_total = sum(nb_doses))

# Lier les donnes de vaccination aux donnees geographiques
#data <- inner_join(livraisonsdf, centroids, by = c("code_departement" = "code")) %>% arrange(nb_doses_total)

# Renomer les colonnes
#names(data)[4] <- "lon"
#names(data)[5] <- "lat"

```

```{r eval=FALSE, include=FALSE}
mybreaks <- c(10000, 25000, 50000, 75000, 100000, 120000)

mapplot =  ggplot(dpt_fortified) +
  geom_polygon(aes(x=long, y = lat, group = group),
               fill="grey",
               color="white",
               alpha=0.3) +
  geom_point(data = data,
             aes(x=lon, y=lat,
                 size=nb_doses_total,
                 color=nb_doses_total,
                 alpha=nb_doses_total),
             shape=20,
             stroke=TRUE) +
  theme_void() +
  coord_map() +
  scale_size_continuous(name="Nbr de doses", trans="log", range=c(1,12), breaks=mybreaks) +
  scale_alpha_continuous(name="Nbr de doses", trans="log", range=c(0.1, .9), breaks=mybreaks) +
  scale_color_viridis(option="magma", trans="log", breaks=mybreaks, name="Nbr de doses") +
  guides( colour = guide_legend() ) +
  ggtitle("Livraisons de vaccins par departement") +
  labs(caption = "Source : geodes.santepubliquefrance.fr - data.gouv.fr") +
  theme(
    text = element_text(color = "#22211d", family = "Brown"),
    legend.position = c(-0.1, 0.45),
    plot.background = element_blank(), 
    panel.background = element_blank(), 
    legend.background = element_blank(),
    plot.caption = element_text(size = 9, color = "#4e4d47", margin = margin(r=1, b = 0.3, unit = "cm")),
    plot.title = element_text(size= 17, hjust=0.1, color = "#4e4d47", margin = margin(b = -0.1, t = 0.4, l = 2, unit = "cm")))

mapplot

```

## __Courbes de la campagne de vaccination dose 1 _(valeurs absolues)___

La vaccination pour la dose 1 a commence le 27 decembre 2020 en ordre plutot disperse.

> __Depuis le début de la campagne de vaccination en France, 2 294 208 premieres injections de vaccin (soit 3,5% de la population totale et 4,3% de la population majeure) et 700 249 deuxiemes injections ont ete realisees _(donnees provisoires en attente de consolidation)___. _- Communique de la DGS - 14 fevrier 2021_

_Une ligne verticale noire delimite l'introduction du vaccin AstraZeneca. Celui-ci, privilegie pour les publics plus jeunes, change la lecture des donnees._


```{r echo=FALSE}
# Courbes de la campagne de vaccination dose 1

# Determiner une ligne verticale a la date de l'introduction du vaccin AZ (6 fevrier)
dose_1_vline <- as.Date(c("2021-02-06"))
dose_1_vline <- which(vacsi_a_fra_2doses$jour %in% dose_1_vline)

colours <- c('#9e0142','#d53e4f','#f46d43','#fdae61','#fee08b','#ffffbf','#e6f598','#abdda4','#66c2a5','#3288bd')

p <- ggplot(vacsi_a_fra_2doses, aes(x = jour, y = cum_dose1, colour=as.character(clage_vacsi)))+
  geom_line(size = 1.2) +
  scale_colour_manual(values = c('#450256','#F9E721','#21908D','#5AC865'),
                      labels = c("40-59 ans", "60-74 ans", "75 ans et plus", "EHPAD")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 - Vaccination",
       subtitle = "par groupe d'ages, en valeurs absolues - dose 1",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.03, b = -0.2, unit = "cm")),
        legend.text = element_text(size = 9, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 9, color = "#767676"),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_line(color = "#d9dddc"),
        panel.grid.major.x = element_line(color = "#d9dddc")) +
  scale_x_date(date_labels = "%d %b", date_breaks = "3 days") +
  scale_y_continuous(limit = c(0,1500000), labels=function(x) format(x, big.mark = " ", scientific = FALSE)) +
  geom_vline(xintercept = as.numeric(vacsi_a_fra_2doses$jour[dose_1_vline]),
             col = "black", lwd = 0.5) +
  geom_label(aes(x = as.Date(c("2021-02-06")), y = 1300000, label = "Introduction du\nvaccin AstraZeneca"), 
                           hjust = "right", 
                           vjust = 0.5, 
                           colour = "#555555", 
                           fill = "transparent", 
                           label.size = NA, 
                           family="Brown", 
                           size = 3)
p
```


## __Courbes de la campagne de vaccination dose 2 _(valeurs absolues)___

L'administration de la deuxieme dose a commence le 26 janvier.

Les courbes sont plus franches, le groupe des 50-59 ans a le plus largement beneficie de la seconde dose.


```{r echo=FALSE}
# Courbes de la campagne de vaccination dose 2

# Modifier la base de donnees pour commencer plus tard
df <- subset(vacsi_a_fra_2doses, vacsi_a_fra_2doses$jour > as.Date("2021-01-23"))

# Determiner une ligne verticale a la date de l'introduction du vaccin AZ (6 fevrier)
dose_2_vline <- as.Date(c("2021-02-06"))
dose_2_vline <- which(df$jour %in% dose_2_vline)

p <- ggplot(df, aes(x = jour, y = cum_dose2, colour = as.character(clage_vacsi))) +
  geom_line(size = 1.2) + #aes(linetype=clage_vacsi)
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  scale_colour_manual(values = c('#450256','#F9E721','#21908D','#5AC865'),
                      labels = c("40-59 ans", "60-74 ans", "75 ans et plus", "EHPAD")) +
  bbc_style() +
  labs(title="COVID-19 - Vaccination",
       subtitle = "par groupe d'ages, en valeurs absolues - dose 2",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.03, b = -0.2, unit = "cm")),
        legend.text = element_text(size = 9, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 9, color = "#767676"),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_line(color = "#d9dddc"),
        panel.grid.major.x = element_line(color = "#d9dddc")) +
  scale_x_date(date_labels = "%d %b", date_breaks = "3 days") +
  scale_y_continuous(limit = c(0,260000), labels=function(x) format(x, big.mark = " ", scientific = FALSE)) +
  geom_vline(xintercept = as.numeric(df$jour[dose_2_vline]),
             col = "black", lwd = 0.5) +
  geom_label(aes(x = as.Date(c("2021-02-06")), y = 200000, label = "Introduction du\nvaccin AstraZeneca"), 
                           hjust = "right", 
                           vjust = 0.5, 
                           colour = "#555555", 
                           fill = "transparent", 
                           label.size = NA, 
                           family="Brown", 
                           size = 3)
p
```


## __Superposition des deux graphiques__

### Alignement des deux courbes precedentes pour comparer le suivi des injections

La courble qui represente les secondes injections a ete ramenee arbitrairement 21 jours en arriere.

Mais toutes les secondes doses ne s'effectuent pas forcement 21 jours plus tard. De plus, la HAS a indique samedi 13 fevrier que les personnes ayant deja contracte le virus peuvent ne recevoir qu'une dose.

Cependant il est difficile de determiner comment superposer les deux courbes car les donnees de vaccination ne sont pas ventilees par vaccin.

Il s'agit donc d'un graphique a lire avec precaution.


```{r echo=FALSE, message=FALSE, warning=FALSE}

#Faire "remonter" les dates de seconde vaccination 21 jours plus tôt pour voir si les courbes se suivent
dt1_bis <- dt1 %>% mutate_at(c("cum_dose2"), funs(lead), n = 21 )
dt2_bis <- dt2 %>% mutate_at(c("cum_dose2"), funs(lead), n = 21 )
dt3_bis <- dt3 %>% mutate_at(c("cum_dose2"), funs(lead), n = 21 )
vacsi_res_fra_bis <- vacsi_res_fra %>% mutate_at(c("cum_dose2"), funs(lead), n = 21 )

#Reconstituer la dataframe dans une nouvelle variable et conserver seulement certaines dates pour "zoomer" dans la periode interessante
vacsi_a_fra_2doses_bis <- rbind(dt1_bis, dt2_bis, dt3_bis, vacsi_res_fra_bis)

vacsi_a_fra_2doses_bis <- subset(vacsi_a_fra_2doses_bis, vacsi_a_fra_2doses_bis$jour < as.Date("2021-01-22"))

vacsi_a_fra_2doses_bis <- subset(vacsi_a_fra_2doses_bis, vacsi_a_fra_2doses_bis$jour > as.Date("2021-01-04"))
  
#Faire le graphique avec les valeurs modifiées en pointillés

p <- ggplot(vacsi_a_fra_2doses_bis, aes(x = jour, colour=as.character(clage_vacsi)))+
  geom_line(aes(y = cum_dose1),  size = 1.2) +
  geom_line(aes(y = cum_dose2), linetype="dotted", size = 1.2) +
  scale_colour_manual(values = c('#450256','#F9E721','#21908D','#5AC865'),
                      labels = c("40-59 ans", "60-74 ans", "75 ans et plus", "EHPAD")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 - Vaccination",
       subtitle = "Comparaisons des trajectoires des vaccinations 1 et 2",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.03, b = -0.2, unit = "cm")),
        legend.text = element_text(size = 9, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 9, color = "#767676"),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_line(color = "#d9dddc"),
        panel.grid.major.x = element_line(color = "#d9dddc")) +
  scale_x_date(date_labels = "%d %b", date_breaks = "3 days") +
  scale_y_continuous(limit = c(0,420000), labels=function(x) format(x, big.mark = " ", scientific = FALSE)) +
  #geom_vline(xintercept = as.numeric(vacsi_a_fra_2doses$jour[dose_1_vline]),
             #col = "black", lwd = 0.5) +
  geom_label(aes(x = as.Date(c("2021-01-06")), y = 320000, label = "Les trajectoires des\nsecondes vaccinations\n(en pointilles)\nont ete ramenees\nartificiellement 21 jours\nplus tot pour suivre\nles premieres series\nd'injections"), 
                           hjust = "left", 
                           vjust = 0.5, 
                           colour = "#696969", 
                           fill = "transparent", 
                           label.size = NA, 
                           family="Brown", 
                           size = 3.2)
p

```

| Nom du vaccin    | Delai apres la premiere dose    |
|------------------|---------------------------------|
| Pfizer BioNTech  | 21 jours                        |
| Moerna           | 28 jours                        |
| AstraZeneca      | 2 a 8 semaines                  |

## __Part de la dose 2 par rapport a la dose 1__

### Sur 100 personnes vaccinees, combien ont recu la seconde dose ?

```{r include=FALSE}
# Stacked bar chart - part de la dose 2 par rapport a la dose 1
# Prepare the data

# Inventer/ajouter un nouvel index pour les ehpad
ehpad_code_age <- c(99)

# Mettre cet index dans une nouvelle colonne
vacsi_res_tot_fra$clage_vacsi <- ehpad_code_age

# Renommer les colonnes pour correspondre avec "vacsi_tot_a_fra"
names(vacsi_res_tot_fra)[names(vacsi_res_tot_fra) == "res_vac_tot_dose1"] <- "n_tot_dose1"
names(vacsi_res_tot_fra)[names(vacsi_res_tot_fra) == "res_vac_tot_dose2"] <- "n_tot_dose2"

# Supprimer les colonnes non essentielles (couverture vaccinale)
vacsi_res_tot_fra <- vacsi_res_tot_fra[ -c(1, 5, 6) ]

# 40-59 ans - Reorganiser les classes d'age comme plus haut
dt4 <- vacsi_tot_a_fra %>%
  filter(clage_vacsi %in% c(49, 59)) %>%
  mutate(jour = ymd(jour)) %>%
  group_by(jour) %>%
  summarise(n_tot_dose1 = sum(n_tot_dose1), n_tot_dose2 = sum(n_tot_dose2))

clagedt4 <- c("49_59")
dt4$clage_vacsi <- clagedt4

# 60-74 ans
dt5 <- vacsi_tot_a_fra %>%
  filter(clage_vacsi %in% c(64, 69, 74)) %>%
  mutate(jour = ymd(jour)) %>%
  group_by(jour) %>%
  summarise(n_tot_dose1 = sum(n_tot_dose1), n_tot_dose2 = sum(n_tot_dose2))

clagedt5 <- c("69_74")
dt5$clage_vacsi <- clagedt5

# 75 ans et plus
dt6 <- vacsi_tot_a_fra %>%
  filter(clage_vacsi %in% c(79, 80)) %>%
  mutate(jour = ymd(jour)) %>%
  group_by(jour) %>%
  summarise(n_tot_dose1 = sum(n_tot_dose1), n_tot_dose2 = sum(n_tot_dose2))

clagedt6 <- c("79_80")
dt6$clage_vacsi <- clagedt6

# Lier les trois dataframes ainsi creees avec les donnees EHPAD
vacsi_res_tot_fra <- vacsi_res_tot_fra %>%
  rbind(dt4, dt5, dt6)

# Supprimer les colonnes non essentielles
dt7 <- vacsi_res_tot_fra[ -c(1) ]

#classe_age2 <- c("59","64","69","79","80","99")

# Passer en format long et ne garder que les indes importants
dt7 <- melt(dt7,  id.vars = "clage_vacsi", variable.name = "series") #%>%
  #filter(clage_vacsi %in%  classe_age2)

```

##### Ce graphique represente la part de doses 2 par rapport a la dose 1 par groupe d'ages, au niveau national.

La campagne de seconde dose a ete plus __uniforme__ avec les 40-59 ans... beaucoup mois avec les 75 ans et plus.

```{r echo=FALSE}
# Make a stacked bar chart
p2 <- ggplot(data = dt7,
            aes(x = as.character(clage_vacsi),
                y = value,
                fill = series)) +
  geom_bar(stat = "identity", 
           position = "fill") +
  scale_fill_manual(values = c("#31688eb3", "#31688e"),
                    labels = c("1ere dose", "2nde dose")) +
  scale_x_discrete(labels  = c("40-59 ans", "60-74 ans", "75 ans et plus", "EHPAD")) +
  bbc_style() +
  scale_y_continuous(labels = scales::percent) +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  labs(title = "COVID-19 - Vaccination",
       subtitle = "Ratio de doses administrees pour les groupes d'ages representes",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown"),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.03, b = 0.08, unit = "cm")),
        legend.text = element_text(size = 9, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 9, color = "#767676"),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_line(color = "#d9dddc"),
        legend.position = "right", 
        legend.justification = "left")

p2
 
```

##### Mais on peut representer la situation d'une autre maniere

En valeurs absolues, on voit que si la vaccination pour les secondes doses est mieux suivie chez les 40-59 ans, la vaccination en general est plus __massive__ chez les 75 ans et plus

```{r echo=FALSE}
p2bis <- ggplot(data = dt7,
            aes(x = as.character(clage_vacsi),
                y = value,
                fill = series)) +
  geom_bar(stat = "identity", 
           position = "identity") +
  scale_fill_manual(values = c("#31688eb3", "#31688e"),
                    labels = c("1ere dose", "2nde dose")) +
  scale_x_discrete(labels  = c("40-59 ans", "60-74 ans", "75 ans et plus", "EHPAD")) +
  bbc_style() +
  scale_y_continuous(labels=function(x) format(x, big.mark = " ", scientific = FALSE)) +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  labs(title = "COVID-19 - Vaccination",
       subtitle = "Part des doses administrees pour les groupes d'ages representes",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown"),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.03, b = 0.08, unit = "cm")),
        legend.text = element_text(size = 9, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 9, color = "#767676"),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_line(color = "#d9dddc"),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_line(color = "#d9dddc"),
        legend.position = "right", 
        legend.justification = "left")

p2bis
```

## __Analyse en proportion de la population__
__40-59 ans - 60-74 ans - 75 ans et plus__

Les graphiques en % permettent de mettre chaque region et chaque tranche d'age au meme niveau.

Le but est de comparer equitablement la couverture vaccinale.

Cette etape est delicate car les groupes d'ages sont repartis differemment sur l'INSEE (donnees de population) et sur data.gouv (donnees de vaccination).

Il y a donc beaucoup de "netoyage"" de donnees a faire en amont.

### __Donnees departemantales__

_Les departements etant tres nombreux, les graphiques sont devises en deux._

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Graphique comparant les doses administrees dans les departements - 40-59 ans

deplist1 <- c("Ain","Aisne","Allier","Alpes-de-Haute-Provence","Hautes-Alpes","Alpes-Maritimes","Ardèche","Ardennes","Ariège","Aube",
              "Aude","Aveyron","Bouches-du-Rhône","Calvados","Cantal","Charente","Charente-Maritime","Cher","Corrèze","Corse-du-Sud",
              "Haute-Corse","Côte-d'Or","Côtes-d'Armor","Creuse","Dordogne","Doubs","Drôme","Eure","Eure-et-Loir","Finistère","Gard",
              "Haute-Garonne","Gers","Gironde","Hérault","Ille-et-Vilaine","Indre","Indre-et-Loire","Isère","Jura","Landes",
              "Loir-et-Cher","Loire","Haute-Loire","Loire-Atlantique","Loiret","Lot","Lot-et-Garonne","Lozère","Maine-et-Loire","Manche")
deplist2 <- c("Marne","Haute-Marne","Mayenne","Meurthe-et-Moselle","Meuse","Morbihan","Moselle","Nièvre","Nord","Oise","Orne",
              "Pas-de-Calais","Puy-de-Dôme","Pyrénées-Atlantiques","Hautes-Pyrénées","Pyrénées-Orientales","Bas-Rhin",
              "Haut-Rhin","Rhône","Haute-Saône","Saône-et-Loire","Sarthe","Savoie","Haute-Savoie","Paris","Seine-Maritime",
              "Seine-et-Marne","Yvelines","Deux-Sèvres","Somme","Tarn","Tarn-et-Garonne","Var","Vaucluse","Vendée","Vienne",
              "Haute-Vienne","Vosges","Yonne","Territoire de Belfort","Essonne","Hauts-de-Seine","Seine-Saint-Denis",
              "Val-de-Marne","Val-d'Oise","Guadeloupe","Martinique","Guyane","La Réunion","Mayotte")

dep_col_values <- c("#99000d", "#99000d80")

p10 <- ggplot(dt9, aes(fill=series, y=value, x=str_wrap(nom, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = dep_col_values,
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination dans les departements",
       subtitle = "Etat de la vaccination chez les 40-59 ans",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 10, color = "#767676"),
        axis.text.x = element_text(size = 6.5, angle = 50, hjust = 1),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 5), breaks = c(0, 1, 2, 3, 4, 5),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  scale_x_discrete(limits = deplist1)

p10

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
p10bis <- ggplot(dt9, aes(fill=series, y=value, x=str_wrap(nom, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = dep_col_values,
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination dans les departements",
       subtitle = "Etat de la vaccination chez les 40-59 ans",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 10, color = "#767676"),
        axis.text.x = element_text(size = 6.5, angle = 50, hjust = 1),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 5), breaks = c(0, 1, 2, 3, 4, 5),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  scale_x_discrete(limits = deplist2)

p10bis
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Graphique comparant les doses administrees dans les departements - 60-74 ans

p11 <- ggplot(dt10, aes(fill=series, y=value, x=str_wrap(nom, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = dep_col_values,
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination dans les departements",
       subtitle = "Etat de la vaccination chez les 60-74 ans",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 10, color = "#767676"),
        axis.text.x = element_text(size = 6.5, angle = 50, hjust = 1),
        axis.text.y = element_text(size = 8),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 5), breaks = c(0:5),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  scale_x_discrete(limits = deplist1)

p11
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
p11bis <- ggplot(dt10, aes(fill=series, y=value, x=str_wrap(nom, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = dep_col_values,
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination dans les departements",
       subtitle = "Etat de la vaccination chez les 60-74 ans",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 10, color = "#767676"),
        axis.text.x = element_text(size = 6.5, angle = 50, hjust = 1),
        axis.text.y = element_text(size = 8),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 10), breaks = c(0:10),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  scale_x_discrete(limits = deplist2)

p11bis
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Graphique comparant les doses administrees dans les departements - 75 ans et plus

p12 <- ggplot(dt11, aes(fill=series, y=value, x=str_wrap(nom, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = dep_col_values,
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination dans les departements",
       subtitle = "Etat de la vaccination chez les 75 ans et plus",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 10, color = "#767676"),
        axis.text.x = element_text(size = 6.5, angle = 50, hjust = 1),
        axis.text.y = element_text(size = 8),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 50), breaks = c(0,5,10,15,20,25,30,35,40,45,50),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  scale_x_discrete(limits = deplist1)

p12
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
p12bis <- ggplot(dt11, aes(fill=series, y=value, x=str_wrap(nom, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = dep_col_values,
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination dans les departements",
       subtitle = "Etat de la vaccination chez les 75 ans et plus",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 10, color = "#767676"),
        axis.text.x = element_text(size = 6.5, angle = 50, hjust = 1),
        axis.text.y = element_text(size = 8),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 50), breaks = c(0,5,10,15,20,25,30,35,40,45,50),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  scale_x_discrete(limits = deplist2)

p12bis
```

### __Donnees regionales__

Le graphique ci-dessous montre que, proportionnellement a leur population, les DROM ont recu moins de vaccins, doses 1 et 2 confondues.

On constate aussi des disparites entre les regions.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Graphique comparant les doses administrees en poucentage de la population totale

p3 <- ggplot(df2, aes(fill=series, y=value, x=str_wrap(noms, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = c("#08589e", "#08589e80"),
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination en France",
       subtitle = "Etat de la vaccination en % de la population totale",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 10, color = "#767676"),
        axis.text.x = element_text(angle = 0, hjust = 0),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 5), breaks = c(0, 1, 2, 3, 4, 5),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  coord_flip()

p3
```

Plus en details, le groupe des 40-59 ans apparait homogene et la seconde injection semble bien suivre la premiere.

Bien que pour chaque region, moins de 3% des 40-59 ans sont accines (au 5 fevrier).

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Graphique comparant les doses administr?es en poucentage de la population des 40-59 ans

p4 <- ggplot(df3, aes(fill=series, y=value, x=str_wrap(noms, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = c("#08589e", "#08589e80"),
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination en France",
       subtitle = "Etat de la vaccination en % de la population des 40-59 ans",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 10, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 8, color = "#767676"),
        axis.text.x = element_text(angle = 0, hjust = 0),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 5), breaks = c(0, 1, 2, 3, 4, 5),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  coord_flip()

p4
```

La deuxieme injection suit moins rapidement la premiere pour les 60-74 ans.

Surtout a Mayotte, ou plus de 3% de ce groupe a recu la premiere dose et presque personne n'a recu la seconde.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Graphique comparant les doses administrees en poucentage de la population des 60-74 ans

p5 <- ggplot(df4, aes(fill=series, y=value, x=str_wrap(noms, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = c("#08589e", "#08589e80"),
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination en France",
       subtitle = "Etat de la vaccination en % de la population des 60-74 ans",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 8, color = "#767676"),
        axis.text.x = element_text(angle = 0, hjust = 0),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 10), breaks = c(0:10),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  coord_flip()

p5
```

Le ratio est encore plus large dans le groupe des plus de 75 ans.

Notez que l'echelle a change et va de 0 a 30%.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Graphique comparant les doses administrees en poucentage de la population des 75 ans et plus

p6 <- ggplot(df5, aes(fill=series, y=value, x=str_wrap(noms, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = c("#08589e", "#08589e80"),
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination en France",
       subtitle = "Etat de la vaccination en % de la population des 75 ans et plus",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 8, color = "#767676"),
        axis.text.x = element_text(angle = 0, hjust = 0),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 30), breaks = c(0,5,10,15,20,25,30),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  coord_flip()

p6
```

L'etat de la vaccination est bien avance dans les EHPAD avec presque 100% des residents corses ayant recu la premiere dose.

Pourtant dans les EHPAD d'Outre-mer, et particulierement en Guadeloupe et en Guyane, l'ecart est tres marque entre la premiere et la seconde injection.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Graphique comparant les doses administrees en poucentage de la population en EHPAD

p7 <- ggplot(df6, aes(fill=series, y=value, x=str_wrap(noms, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = c("#08589e", "#08589e80"),
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination en France",
       subtitle = "Etat de la vaccination en % de la population residant en EHPAD",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 8, color = "#767676"),
        axis.text.x = element_text(angle = 0, hjust = 0),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 100), breaks = c(0,10,20,30,40,50,60,70,80,90,100),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  coord_flip()

p7
```

## __Part des soignants dans la population__

```{r echo=FALSE}
# Donut chart pour comparer population de soignants par rapport a la population generale

# Create dataframe
data <- data.frame(
  category=c("Personnel de sante\n elegible a la vaccination", "Autre personnel de sante", "Reste de la population"),
  count=c(972505,972505,65477231)
)

# Compute percentages
data$fraction = data$count / sum(data$count)
# Compute the cumulative percentages (top of each rectangle)
data$ymax = cumsum(data$fraction)
# Compute the bottom of each rectangle
data$ymin = c(0, head(data$ymax, n=-1))
# Compute label position
data$labelPosition <- (data$ymax + data$ymin) / 2
# Compute a good label
data$label <- paste0(data$category,"\n", data$count)

# Make the plot
p8 <- ggplot(data, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=2.5, fill=category)) +
  geom_rect() +
  scale_fill_manual(values = c("#de4414","#fde624","#31688e")) +
  geom_text(x=2.5, aes(y=labelPosition, label=label, family = "Brown"), size=3.5) + # x here controls label position (inner / outer)
  coord_polar(theta="y") + # Try to remove that to understand how the chart is built initially
  xlim(c(0.5, 4)) + # Try to remove that to see how to make a pie chart
  theme_void() +
  theme(legend.position = "none")

p8
```

## __Evolution du taux d'incidence par groupe d'ages__

Le taux d'incidence moyen hebdomadaire reste eleve chez les + de 80 ans.

_Taux d'incidence = nombre de cas positifs pour 100 000 personnes par semaine._

```{r echo=FALSE}
# Reorganiser les classes d'age comme plus haut
#dt8 <- sp_pos_quot_fra %>%
#  filter(cl_age90 %in% c(49, 59)) %>%
#  mutate(jour = ymd(jour)) %>%
#  group_by(jour) %>%
#  summarise(P = sum(P))

#clagedt8 <- c("49_59")
#dt8$cl_age49_59 <- clagedt8

# Selectionner les colonnes et les valeurs utiles dans les donnees de taux d'incidence et les mettre dans une nouvelle variable
dt8 <- sp_pos_quot_fra[ c(2,5,9,10) ]

dt8 <- dt8 %>%
  filter(cl_age90 != c("0"))


# Faire le taux d'incidence sur 7 jours
dt8 <- dt8 %>%
  mutate(jour = ymd(jour)) %>%
  arrange(cl_age90) %>%
  mutate(somme = P + lag(P,1) + lag(P,2) + lag(P,3)+ lag(P,4)+ lag(P,5)+ lag(P,6)) %>%
  group_by(cl_age90, pop) %>%
  filter(jour > as.Date("2020-06-29")) %>%
  summarise_by_time (.date_var = jour,
                     .by = "week",
                     mean = mean(somme)) %>%
  mutate(incid = round(mean/pop*100000))

# Prerparer les donnees pour la carte de chaleur

m <- dt8 %>%
  # convert "cl_age90" to factor and reverse order of levels
  mutate(cl_age90=factor(cl_age90,levels=rev(sort(unique(cl_age90))))) %>%
  # create a new variable from incid
  mutate(incidfactor=cut(incid,breaks=c(-1,0,10,20,50,100,150,200,250,300,350,400,450,500,550,
                                        600,650,700,750,800,max(incid,na.rm=T)),
                         labels=c("0","0-10","10-20","20-50","50-100","100-150",
                                  "150-200","200-250","250-300","300-350",
                                  "350-400","400-450", "450-500","500-550","550-600",
                                  "600-650", "650-700","700-750","750-800","< 800")))
  # change level order
  #mutate(incidfactor=factor(as.character(incidfactor),levels=rev(levels(incidfactor))))

# Build a further modified heat map

textcol <- "grey40"
#plasma(20)

p2 <- ggplot(m, aes(x = jour, y = as.character(cl_age90), fill = incidfactor))+
  geom_tile(colour="white",size=0.2)+
  guides(fill=guide_legend(title="par 100k hab."))+
  labs(x="",y="",
       title="Evolution des taux d'incidence",
       subtitle = "Par groupe d'ages par semaine glissante")+
  scale_y_discrete(expand=c(0,0),
                   labels=c("0-9 ans","9-19 ans","20-29 ans","30-39 ans","40-49 ans","50-59 ans","60-69 ans",
                            "70-79 ans","80-89 ans","+ de 80 ans"))+
  scale_x_date(expand=c(0,0), breaks = "week", date_labels = "%d %b") +
  scale_fill_manual(values=c("#0D0887FF","#2D0594FF","#44039EFF","#5901A5FF","#6F00A8FF",
                             "#8305A7FF","#9512A1FF","#A72197FF","#B6308BFF","#C5407EFF",
                             "#D14E72FF","#DD5E66FF","#E76E5BFF","#EF7F4FFF","#F79044FF",
                             "#FBA238FF","#FEB72DFF","#FDCB26FF","#F7E225FF","#F0F921FF"),na.value = "grey90")+
  theme_grey(base_size=10)+
  theme(plot.title=element_text(colour="#444444",hjust=0,size=16,family = "Brown"),
        plot.subtitle = element_text(colour="#444444",hjust=0,size=12,family = "Brown"),
        legend.position="right",legend.direction="vertical",
        legend.title=element_text(colour=textcol),
        legend.margin=margin(grid::unit(0,"cm")),
        legend.text=element_text(colour=textcol,size=7,family = "Brown"),
        legend.key.height=grid::unit(0.2,"cm"),
        legend.key.width=grid::unit(0.2,"cm"),
        axis.text.x=element_text(size=8,colour=textcol,family = "Brown", angle = 50, hjust = 1),
        axis.text.y=element_text(size=8, vjust=0.2,colour=textcol,family = "Brown"),
        axis.ticks=element_line(size=0.4),
        plot.background=element_blank(),
        panel.border=element_blank())
        #plot.margin=margin(0.7,0.4,0.1,0.2,"cm")
p2

```


***

__Donnees a retrouver sur [data.gouv.fr](data.gouv.fr), [Geodes](https://geodes.santepubliquefrance.fr/#c=home), [Drees](http://www.data.drees.sante.gouv.fr/)__

Markdown cree par __[Hugo Barbieux](https://twitter.com/hugobarbieux)__