---
title: "L'Oeil du 20h"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
output: html_document
---
## Etat des lieux de la vaccination en France

Ce "markdown" est dedie a la datavisualisation des donnees sur la vacination contre le COVID-19.

Le but : voir si la vaccination privilegie un groupe de personnes et si les departements d'Outre-mer sont laisses de cote.


```{r include=FALSE}
# Packages necessaires

#install.packages("tidyverse")
#install.packages("lubridate")
#install.packages("zoo")
#install.packages("reshape2")
#install.packages("viridis")
#install.packages("timetk")
library(tidyverse)
library(lubridate)
library(zoo)
library(reshape2)
library(viridis)
library(timetk)
```

#### Ci-dessous, les sources pour les données de vaccination :

```{r echo=TRUE}
# Liens de telechargement vers les donnees de data.gouv.fr

#nombre quotidien de residents en EHPAD ayant reçu au moins une dose ou deux doses, par date d'injection
url1 <- "https://www.data.gouv.fr/fr/datasets/r/72d3b91e-ef24-4c91-a3c3-52b72d418000"
#nombre de residents en EHPAD ayant reçu au moins une dose ou deux doses ainsi que la couverture vaccinale, arrete a la derniere date disponible
url2 <- "https://www.data.gouv.fr/fr/datasets/r/104f3ab1-de0f-41c5-9bd8-edab9926882c"
#nombre quotidien de personnes ayant reçu au moins une dose, par classes d'age, et par date d'injection
url3 <- "https://www.data.gouv.fr/fr/datasets/r/54dd5f8d-1e2e-4ccb-8fb8-eac68245befd"
#nombre de personnes ayant reçu au moins une dose ou deux doses, par classes d'age, arrete a la derniere date disponible
url4 <- "https://www.data.gouv.fr/fr/datasets/r/dc103057-d933-4e4b-bdbf-36d312af9ca9"
#nombre de personnes ayant reçu au moins une dose ou deux doses, par classes d'age, arrete a la derniere date disponible, echelle regionale
url5 <- "https://www.data.gouv.fr/fr/datasets/r/2dadbaa7-02ae-43df-92bb-53a82e790cb2"
#nombre de residents en EHPAD ayant re?u au moins une dose ou deux doses ainsi que la couverture vaccinale, arrete la derniere date disponible, echelle regionale
url6 <-"https://www.data.gouv.fr/fr/datasets/r/5cb5a964-a8f7-4111-b527-1a2d48dee3d4"
#nombre de personnes testées et le nombre de personnes déclarées positives par sexe et classe d'âge
url7 <- "https://www.data.gouv.fr/fr/datasets/r/dd0de5d9-b5a5-4503-930a-7b08dc0adc7c"
```

```{r include=FALSE}
# Lire les donnees de data.gouv

vacsi_res_fra <- read.csv(url1)
vacsi_res_tot_fra <- read.csv(url2)
vacsi_a_fra <- read.csv(url3) %>%
  arrange(clage_vacsi)
vacsi_tot_a_fra <- read.csv(url4)
vacsi_tot_a_reg <- read.csv(url5) # colClasses = c(reg = "character"))
vacsi_res_tot_reg_fra <- read.csv(url6)
sp_pos_quot_fra <- read.csv(url7, sep = ";", colClasses = c(cl_age90 = "character"))
```


#### Attention : la seconde dose ne figure pas toujours dans data.gouv.fr !


Il faut retrouver ces donnees sur Geodes et les ajouter au tableau.

Geodes propose le total des secondes injections par jour. Les récuperer se fait largement a la main.



```{r include=FALSE}
# Attention : "vacsi_a_fra" (vaccination age quotidien) ne mentionne pas la seconde dose !
# Il faut d'abord retrouver ces donnees sur Geodes et les ajouter au tableau - Geodes propose le total des secondes injections par jour.

# Creer un variable "vacsi_a_fra_dose2" et y importer les donnees de seconde vaccination par jour de Geodes

vacsi_a_fra_dose2 <- read.csv("geodes.csv", header = T) %>%
  pivot_longer(c(2:12), names_to ="clage_vacsi") %>% # passer du format wide au format long
  arrange(clage_vacsi)

# Enlever les X qui venaient du nom des colonnes

vacsi_a_fra_dose2$clage_vacsi <- stringr::str_replace(vacsi_a_fra_dose2$clage_vacsi, "X", "") %>%
  as.numeric(vacsi_a_fra_dose2$clage_vacsi)

# Combiner aux data "vacsi_a_fra" dans une nouvelle variable appelee "vacsi_a_fra_2doses"

vacsi_a_fra_2doses <- left_join(vacsi_a_fra, vacsi_a_fra_dose2, by=c("jour"="jour", "clage_vacsi"="clage_vacsi")) %>%
  rename(n_cum_dose2 = value)

# Calculer le nombre journalier de vaccination 2

vacsi_a_fra_2doses <- vacsi_a_fra_2doses %>%
  mutate(jour = ymd(jour)) %>%
  arrange(clage_vacsi, jour) %>%
  mutate(n_dose2 = n_cum_dose2-lag(n_cum_dose2))

vacsi_a_fra_2doses[vacsi_a_fra_2doses<0] <- 0 # petit truc pour regler un bug avec la fonction lag

```

```{r include=FALSE}
# Maintenant nous avons une base de donnees "vacsi_a_fra_2doses" qui comprend les deux injections par jour et par tranche d'age.
# Il faut faire correspondre les tranches d'age de data.gouv.fr avec les tranches de l'INSEE
# Donc assimiler les tranches 49 et 59, 69 et 74, 79 et 80

dt1 <- vacsi_a_fra_2doses %>%
  filter(clage_vacsi %in% c(49, 59)) %>%
  mutate(jour = ymd(jour)) %>%
  group_by(jour) %>%
  summarise(cum_dose1 = sum(n_cum_dose1), cum_dose2 = sum(n_cum_dose2))

clagedt1 <- c("49_59")

dt1$clage_vacsi <- clagedt1

dt2 <- vacsi_a_fra_2doses %>%
  filter(clage_vacsi %in% c(69, 74)) %>%
  mutate(jour = ymd(jour)) %>%
  group_by(jour) %>%
  summarise(cum_dose1 = sum(n_cum_dose1), cum_dose2 = sum(n_cum_dose2))

clagedt2 <- c("69_74")

dt2$clage_vacsi <- clagedt2

dt3 <- vacsi_a_fra_2doses %>%
  filter(clage_vacsi %in% c(79, 80)) %>%
  group_by(jour) %>%
  summarise(cum_dose1 = sum(n_cum_dose1), cum_dose2 = sum(n_cum_dose2))

clagedt3 <- c("79_80")

dt3$clage_vacsi <- clagedt3

# Avant de réassembler "vacsi_a_fra_2doses" avec les nouvelles classes d'age, transformer les donnees ehpad pour qu'elles soient compatibles avec "vacsi_a_fra_2doses"

# Netoyage des donnees ehpad :
# Inventer/ajouter un nouvel index pour les ehpad
ehpad_code_age <- c("FR99")
# Mettre cet index dans une nouvelle colonne
vacsi_res_fra$clage_vacsi <- ehpad_code_age
# Garder les colonnes utiles pour fusionner toutes les dataframes
vacsi_res_fra <- vacsi_res_fra [ c(2,5,6,7) ]
# Renommer les colonnes pour correspondre avec les autres dt
names(vacsi_res_fra)[names(vacsi_res_fra) == "res_vac_cum_dose1"] <- "cum_dose1"
names(vacsi_res_fra)[names(vacsi_res_fra) == "res_vac_cum_dose2"] <- "cum_dose2"

vacsi_res_fra <- vacsi_res_fra %>%
  mutate(jour = ymd(jour))

#Assembler les donnees

vacsi_a_fra_2doses <- rbind(dt1, dt2, dt3, vacsi_res_fra)
```

```{r include=FALSE}
# Importer les libraries pour construire un graphique

#This line of code installs the pacman page if you do not have it installed - if you do, it simply loads the package
#if(!require(pacman))install.packages("pacman")

pacman::p_load('dplyr', 'tidyr', 'gapminder',
               'ggplot2',  'ggalt',
               'forcats', 'R.utils', 'png', 
               'grid', 'ggpubr', 'scales',
               'bbplot')

#install.packages(extrafont)
library(extrafont)
```


## Courbes de la campagne de vaccination dose 1


La vaccination pour la dose 1 a commence le 27 decembre 2020 en ordre plutot disperse.


Une ligne verticale noire délimite l'introduction du vaccin AstraZeneca. Celui-ci, privilegie pour les publics plus jeunes, change la lecture des donnees.


```{r echo=FALSE}
# Courbes de la campagne de vaccination dose 1

# Determiner une ligne verticale à la date de l'introduction du vaccin AZ (6 fevrier)
dose_1_vline <- as.Date(c("2021-02-06"))
dose_1_vline <- which(vacsi_a_fra_2doses$jour %in% dose_1_vline)

colours <- c('#9e0142','#d53e4f','#f46d43','#fdae61','#fee08b','#ffffbf','#e6f598','#abdda4','#66c2a5','#3288bd')

p <- ggplot(vacsi_a_fra_2doses, aes(x = jour, y = cum_dose1, colour=as.character(clage_vacsi)))+
  geom_line(size = 1.2) +
  scale_colour_manual(values = c('#450256','#F9E721','#21908D','#5AC865'),
                      labels = c("40-59 ans", "60-74 ans", "75 ans et plus", "EHPAD")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 - Vaccination",
       subtitle = "par groupe d'ages, en valeurs absolues - dose 1",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.03, b = -0.2, unit = "cm")),
        legend.text = element_text(size = 9, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 9, color = "#767676"),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_line(color = "#d9dddc"),
        panel.grid.major.x = element_line(color = "#d9dddc")) +
  scale_x_date(date_labels = "%d %b", date_breaks = "3 days") +
  scale_y_continuous(limit = c(0,1250000), labels=function(x) format(x, big.mark = " ", scientific = FALSE)) +
  geom_vline(xintercept = as.numeric(vacsi_a_fra_2doses$jour[dose_1_vline]),
             col = "black", lwd = 0.5) +
  geom_label(aes(x = as.Date(c("2021-02-06")), y = 1240000, label = "Introduction du\nvaccin AstraZeneca"), 
                           hjust = "right", 
                           vjust = 0.5, 
                           colour = "#555555", 
                           fill = "transparent", 
                           label.size = NA, 
                           family="Brown", 
                           size = 3)
p
```



## Courbes de la campagne de vaccination dose 2

L'administration de la deuxieme dose a commence le 26 janvier.

Les courbes sont plus franches, le groupe des 50-59 ans a le plus largement beneficie de la seconde dose.



```{r echo=FALSE}
# Courbes de la campagne de vaccination dose 2

# Modifier la base de donnees pour commencer plus tard
df <- subset(vacsi_a_fra_2doses, vacsi_a_fra_2doses$jour > as.Date("2021-01-23"))

# Determiner une ligne verticale à la date de l'introduction du vaccin AZ (6 fevrier)
dose_2_vline <- as.Date(c("2021-02-06"))
dose_2_vline <- which(df$jour %in% dose_2_vline)

p <- ggplot(df, aes(x = jour, y = cum_dose2, colour = as.character(clage_vacsi))) +
  geom_line(size = 1.2) + #aes(linetype=clage_vacsi)
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  scale_colour_manual(values = c('#450256','#F9E721','#21908D','#5AC865'),
                      labels = c("40-59 ans", "60-74 ans", "75 ans et plus", "EHPAD")) +
  bbc_style() +
  labs(title="COVID-19 - Vaccination",
       subtitle = "par groupe d'ages, en valeurs absolues - dose 2",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.03, b = -0.2, unit = "cm")),
        legend.text = element_text(size = 9, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 9, color = "#767676"),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_line(color = "#d9dddc"),
        panel.grid.major.x = element_line(color = "#d9dddc")) +
  scale_x_date(date_labels = "%d %b", date_breaks = "3 days") +
  scale_y_continuous(limit = c(0,125000), labels=function(x) format(x, big.mark = " ", scientific = FALSE)) +
  geom_vline(xintercept = as.numeric(df$jour[dose_2_vline]),
             col = "black", lwd = 0.5) +
  geom_label(aes(x = as.Date(c("2021-02-06")), y = 122000, label = "Introduction du\nvaccin AstraZeneca"), 
                           hjust = "right", 
                           vjust = 0.5, 
                           colour = "#555555", 
                           fill = "transparent", 
                           label.size = NA, 
                           family="Brown", 
                           size = 3)
p
```



## Part de la dose 2 par rapport a la dose 1


```{r include=FALSE}
# Stacked bar chart - part de la dose 2 par rapport a la dose 1
# Prepare the data

# Inventer/ajouter un nouvel index pour les ehpad
ehpad_code_age <- c(99)

# Mettre cet index dans une nouvelle colonne
vacsi_res_tot_fra$clage_vacsi <- ehpad_code_age

# Renommer les colonnes pour correspondre avec "vacsi_tot_a_fra"
names(vacsi_res_tot_fra)[names(vacsi_res_tot_fra) == "res_vac_tot_dose1"] <- "n_tot_dose1"
names(vacsi_res_tot_fra)[names(vacsi_res_tot_fra) == "res_vac_tot_dose2"] <- "n_tot_dose2"

# Supprimer les colonnes non essentielles (couverture vaccinale)
vacsi_res_tot_fra <- vacsi_res_tot_fra[ -c(1, 5, 6) ]

# Reorganiser les classes d'age comme plus haut

dt4 <- vacsi_tot_a_fra %>%
  filter(clage_vacsi %in% c(49, 59)) %>%
  mutate(jour = ymd(jour)) %>%
  group_by(jour) %>%
  summarise(n_tot_dose1 = sum(n_tot_dose1), n_tot_dose2 = sum(n_tot_dose2))

clagedt4 <- c("49_59")
dt4$clage_vacsi <- clagedt4

dt5 <- vacsi_tot_a_fra %>%
  filter(clage_vacsi %in% c(64, 69, 74)) %>%
  mutate(jour = ymd(jour)) %>%
  group_by(jour) %>%
  summarise(n_tot_dose1 = sum(n_tot_dose1), n_tot_dose2 = sum(n_tot_dose2))

clagedt5 <- c("69_74")
dt5$clage_vacsi <- clagedt5

dt6 <- vacsi_tot_a_fra %>%
  filter(clage_vacsi %in% c(79, 80)) %>%
  mutate(jour = ymd(jour)) %>%
  group_by(jour) %>%
  summarise(n_tot_dose1 = sum(n_tot_dose1), n_tot_dose2 = sum(n_tot_dose2))

clagedt6 <- c("79_80")
dt6$clage_vacsi <- clagedt6

# Lier les deux dataframes
vacsi_res_tot_fra <- vacsi_res_tot_fra %>%
  rbind(dt4, dt5, dt6)

# Supprimer les colonnes non essentielles
dt7 <- vacsi_res_tot_fra[ -c(1) ]

#classe_age2 <- c("59","64","69","79","80","99")

# Passer en format long et ne garder que les indes importants
dt7 <- melt(dt7,  id.vars = "clage_vacsi", variable.name = "series") #%>%
  #filter(clage_vacsi %in%  classe_age2)

```



Ce graphique représente la part de doses 2 par rapport à la dose 1 par groupe d'age, au niveau national.

Encore une fois, la campagne de seconde dose a ete plus genereuse avec les 40-59 ans... beaucoup mois avec les 75 ans et plus.



```{r echo=FALSE}
# Make a stacked bar chart

p2 <- ggplot(data = dt7,
            aes(x = as.character(clage_vacsi),
                y = value,
                fill = series)) +
  geom_bar(stat = "identity", 
           position = "fill") +
  scale_fill_manual(values = c("#31688e", "#fde624"),
                    labels = c("1ere dose", "2nde dose")) +
  scale_x_discrete(labels  = c("40-59 ans", "60-74 ans", "75 ans et plus", "EHPAD")) +
  bbc_style() +
  scale_y_continuous(labels = scales::percent) +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  labs(title = "COVID-19 - Vaccination",
       subtitle = "Ratio de doses administrees pour les groupes d'ages representes",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown"),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.03, b = 0.08, unit = "cm")),
        legend.text = element_text(size = 9, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 9, color = "#767676"),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_line(color = "#d9dddc"),
        legend.position = "right", 
        legend.justification = "left")

p2
 
```


## Analyse en proportion de la population

Les graphiques en % permettent de mettre chaque region et char tranche d'age au meme niveau.

Cette etape est delicate car les groupes d'ages sont repartis differemment sur l'INSEE (donnees de population) et sur data.gouv (donnees de vaccination).

Donc il y a pas mal de netoyage de donnees a faire en amont.



```{r include=FALSE}
# Preparation des donnees pour des graphique comparant l'avancement de la vaccination par regions et par tranches d'ages, en pourcentage de la population concernee
# Beaucoup d'etapes !

# D'abord importer les donnees INSEE avec la population par regions et le code region

reg_pop <- read.csv("population_regions.csv",
                    sep = ",",
                    header = TRUE,
                    encoding = "UTF-8",
                    skip = 4) %>%
  select(noms = c(1), reg = c(2), `40_59` = c(5), `60_74` = c(6), `75_plus` = c(7), pop_total = Total) %>%
  na.omit(reg_pop)

```

```{r include=FALSE}
# Population totale (indice 0) dans les data de data.gouv
# Assembler avec les donnees INSEE

df2 <- vacsi_tot_a_reg %>%
  filter(clage_vacsi == 0)

df2 <-left_join(df2, reg_pop, by = "reg") %>%
  na.omit(df2) %>%
  mutate(`%_population_dose1` = round(n_tot_dose1/(as.numeric(pop_total))*100, digits = 2)) %>%
  mutate(`%_population_dose2` = round(n_tot_dose2/(as.numeric(pop_total))*100, digits = 2))

df2 <- df2[ c(6, 11, 12) ]

df2 <- melt(df2,  id.vars = "noms", variable.name = "series")
```

```{r include=FALSE}
# Donnees pour la tranche d'age 40-59 ans comme classes par l'INSEE

# Les tranches d'ages sont decoupees differemment sur data.gouv
# Il faut rassembler les classes d'age 49 et 59, 69 et74, 79 et 80 pour correspondre avec le classement INSEE

# 40-59 ans

df3 <- vacsi_tot_a_reg %>%
  filter(clage_vacsi %in% c(49, 59)) %>%
  group_by(reg) %>%
  summarise(n_tot_dose1 = sum(n_tot_dose1), n_tot_dose2 = sum(n_tot_dose2))

df3 <-left_join(df3, reg_pop, by = "reg") %>%
  na.omit(df3) %>%
  mutate(`%_population_dose1` = round(n_tot_dose1/(as.numeric(`40_59`))*100, digits = 2)) %>%
  mutate(`%_population_dose2` = round(n_tot_dose2/(as.numeric(`40_59`))*100, digits = 2))

df3 <- df3[ c(4, 9, 10) ]

df3 <- melt(df3,  id.vars = "noms", variable.name = "series")
```

```{r include=FALSE}
# 60-74 ans

df4 <- vacsi_tot_a_reg %>%
  filter(clage_vacsi %in% c(69, 74)) %>%
  group_by(reg) %>%
  summarise(n_tot_dose1 = sum(n_tot_dose1), n_tot_dose2 = sum(n_tot_dose2))

df4 <-left_join(df4, reg_pop, by = "reg") %>%
  na.omit(df4) %>%
  mutate(`%_population_dose1` = round(n_tot_dose1/(as.numeric(`60_74`))*100, digits = 2)) %>%
  mutate(`%_population_dose2` = round(n_tot_dose2/(as.numeric(`60_74`))*100, digits = 2))

df4 <- df4[ c(4, 9, 10) ]

df4 <- melt(df4,  id.vars = "noms", variable.name = "series")
```

```{r include=FALSE}
# 75 ans et plus ans

df5 <- vacsi_tot_a_reg %>%
  filter(clage_vacsi %in% c(79, 80)) %>%
  group_by(reg) %>%
  summarise(n_tot_dose1 = sum(n_tot_dose1), n_tot_dose2 = sum(n_tot_dose2))

df5 <-left_join(df5, reg_pop, by = "reg") %>%
  na.omit(df5) %>%
  mutate(`%_population_dose1` = round(n_tot_dose1/(as.numeric(`75_plus`))*100, digits = 2)) %>%
  mutate(`%_population_dose2` = round(n_tot_dose2/(as.numeric(`75_plus`))*100, digits = 2))

df5 <- df5[ c(4, 9, 10) ]

df5 <- melt(df5,  id.vars = "noms", variable.name = "series")
```



Le graphique ci-dessous montre que, proportionnellement à leur population, les territoires d'Outre-mer ont reçu moins de vaccins, doses 1 et 2 confondues.

On constate aussi des disparites entre les regions.



```{r echo=FALSE}
# Graphique comparant les doses administr?es en poucentage de la population totale

p3 <- ggplot(df2, aes(fill=series, y=value, x=str_wrap(noms, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = c("#31688e", "#fde624"),
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination en France",
       subtitle = "Etat de la vaccination en % de la population totale",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 10, color = "#767676"),
        axis.text.x = element_text(angle = 0, hjust = 0),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 5), breaks = c(0, 1, 2, 3, 4, 5),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  coord_flip()

p3
```



Plus en détail, le groupe des 40-59 ans apparait homogene et la seconde injection semble bien suivre la premiere.

Bien que pour chaque region, moins de 3% des 40-59 ans sont accines (au 5 fevrier).



```{r echo=FALSE}
# Graphique comparant les doses administr?es en poucentage de la population des 40-59 ans

p4 <- ggplot(df3, aes(fill=series, y=value, x=str_wrap(noms, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = c("#31688e", "#fde624"),
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination en France",
       subtitle = "Etat de la vaccination en % de la population des 40-59 ans",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 10, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 8, color = "#767676"),
        axis.text.x = element_text(angle = 0, hjust = 0),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 5), breaks = c(0, 1, 2, 3, 4, 5),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  coord_flip()

p4
```



La deuxieme injection suit moins rapidement la premiere pour les 60-74 ans.

Surtout à Mayotte, ou plus de 3% de ce groupe a recu la premiere dose et presque personne n'a recu la seconde.



```{r echo=FALSE}
# Graphique comparant les doses administr?es en poucentage de la population des 60-74 ans

p5 <- ggplot(df4, aes(fill=series, y=value, x=str_wrap(noms, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = c("#31688e", "#fde624"),
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination en France",
       subtitle = "Etat de la vaccination en % de la population des 60-74 ans",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 8, color = "#767676"),
        axis.text.x = element_text(angle = 0, hjust = 0),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 5), breaks = c(0, 1, 2, 3, 4, 5),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  coord_flip()

p5
```



Le ratio est encore plus large dans le groupe des plus de 75 ans.

Notez que l'echelle a change et va de 0 a 30%.



```{r echo=FALSE}
# Graphique comparant les doses administr?es en poucentage de la population des 75 ans et plus

p6 <- ggplot(df5, aes(fill=series, y=value, x=str_wrap(noms, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = c("#31688e", "#fde624"),
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination en France",
       subtitle = "Etat de la vaccination en % de la population des 75 ans et plus",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 8, color = "#767676"),
        axis.text.x = element_text(angle = 0, hjust = 0),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 30), breaks = c(0,5,10,15,20,25,30),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  coord_flip()

p6
```



L'etat de la vaccination est bien avance dans les EHPAD avec presque 100% des residents corses ayant recu la premiere dose.

Pourtant dans les EHPAD d'Outre-mer, et particulierement en Guadeloupe et en Guyane, l'ecart est tres marque entre la premiere et la seconde injection.



```{r include=FALSE}
# Avancement de la vaccination dans les EHPAD, classement par r?gion

df6 <- vacsi_res_tot_reg_fra %>%
  inner_join(reg_pop, by = "reg")

df6 <- df6[ c(7,5,6) ]

df6 <- melt(df6,  id.vars = "noms", variable.name = "series")
```

```{r echo=FALSE}
# Graphique comparant les doses administrees en poucentage de la population des 75 ans et plus

p7 <- ggplot(df6, aes(fill=series, y=value, x=str_wrap(noms, 40))) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = c("#31688e", "#fde624"),
                    labels = c("1ere dose", "2nde dose")) +
  geom_hline(yintercept = 0, size = 1, colour="#767676") +
  bbc_style() +
  labs(title="COVID-19 | Vaccination en France",
       subtitle = "Etat de la vaccination en % de la population resident en EHPAD",
       caption = "Source : data.gouv.fr") +
  theme(plot.title = element_text(size = 15, color = "#4e4d47", family = "Brown",
                                  margin = margin(t = -0.1, unit = "cm")),
        plot.subtitle = element_text(size = 12, color = "#4e4d47", family = "Brown",
                                     margin = margin(t = -0.01, unit = "cm")),
        legend.text = element_text(size = 8, family = "Brown"),
        axis.text = element_text(family = "Brown", size = 8, color = "#767676"),
        axis.text.x = element_text(angle = 0, hjust = 0),
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(color = "#cbcbcb"),
        panel.grid.minor.x = element_blank()) +
  scale_y_continuous(limit = c(0, 100), breaks = c(0,10,20,30,40,50,60,70,80,90,100),
                     labels = scales::percent_format(scale = 1, accuracy = 1)) +
  coord_flip()

p7
```


## Part des soignants de 50 ans et plus dans la population

```{r echo=FALSE}
# Donut chart pour comparer population de soignants par rapport à la population générale

# Create dataframe
data <- data.frame(
  category=c("Personnel de sante\n+ 50 ans", "Reste de la population"),
  count=c(535630,67422241)
)

# Compute percentages
data$fraction = data$count / sum(data$count)
# Compute the cumulative percentages (top of each rectangle)
data$ymax = cumsum(data$fraction)
# Compute the bottom of each rectangle
data$ymin = c(0, head(data$ymax, n=-1))
# Compute label position
data$labelPosition <- (data$ymax + data$ymin) / 2
# Compute a good label
data$label <- paste0(data$category,"\n", data$count)

# Make the plot
p8 <- ggplot(data, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=category)) +
  geom_rect() +
  scale_fill_manual(values = c("#fde624", "#31688e")) +
  geom_text(x=1.3, aes(y=labelPosition, label=label, family = "Brown"), size=4) + # x here controls label position (inner / outer)
  coord_polar(theta="y") + # Try to remove that to understand how the chart is built initially
  xlim(c(0.5, 4)) + # Try to remove that to see how to make a pie chart
  theme_void() +
  theme(legend.position = "none")

p8
```

## Evolution du taux d'incidence par groupe d'ages

```{r echo=FALSE}
# Reorganiser les classes d'age comme plus haut
#dt8 <- sp_pos_quot_fra %>%
#  filter(cl_age90 %in% c(49, 59)) %>%
#  mutate(jour = ymd(jour)) %>%
#  group_by(jour) %>%
#  summarise(P = sum(P))

#clagedt8 <- c("49_59")
#dt8$cl_age49_59 <- clagedt8

# Selectionner les colonnes et les valeurs utiles dans les donnees de taux d'incidence et les mettre dans une nouvelle variable
dt8 <- sp_pos_quot_fra[ c(2,5,9,10) ]

dt8 <- dt8 %>%
  filter(cl_age90 != c("0"))


# Faire le taux d'incidence sur 7 jours
dt8 <- dt8 %>%
  mutate(jour = ymd(jour)) %>%
  arrange(cl_age90) %>%
  mutate(somme = P + lag(P,1) + lag(P,2) + lag(P,3)+ lag(P,4)+ lag(P,5)+ lag(P,6)) %>%
  group_by(cl_age90, pop) %>%
  filter(jour > as.Date("2020-06-29")) %>%
  summarise_by_time (.date_var = jour,
                     .by = "week",
                     mean = mean(somme)) %>%
  mutate(incid = round(mean/pop*100000))

# Prerparer les donnees pour la carte de chaleur

m <- dt8 %>%
  # convert "cl_age90" to factor and reverse order of levels
  mutate(cl_age90=factor(cl_age90,levels=rev(sort(unique(cl_age90))))) %>%
  # create a new variable from incid
  mutate(incidfactor=cut(incid,breaks=c(-1,0,10,20,50,100,150,200,250,300,350,400,450,500,550,
                                        600,650,700,750,800,max(incid,na.rm=T)),
                         labels=c("0","0-10","10-20","20-50","50-100","100-150",
                                  "150-200","200-250","250-300","300-350",
                                  "350-400","400-450", "450-500","500-550","550-600",
                                  "600-650", "650-700","700-750","750-800","< 800")))
  # change level order
  #mutate(incidfactor=factor(as.character(incidfactor),levels=rev(levels(incidfactor))))

# Build a further modified heat map

textcol <- "grey40"
#plasma(20)

p2 <- ggplot(m, aes(x = jour, y = as.character(cl_age90), fill = incidfactor))+
  geom_tile(colour="white",size=0.2)+
  guides(fill=guide_legend(title="par 100k hab."))+
  labs(x="",y="",
       title="Evolution des taux d'incidence",
       subtitle = "Par classe d'ages par semaine glissante")+
  scale_y_discrete(expand=c(0,0),
                   labels=c("0-9 ans","9-19 ans","20-29 ans","30-39 ans","40-49 ans","50-59 ans","60-69 ans",
                            "70-79 ans","80-89 ans","+ de 80 ans"))+
  scale_x_date(expand=c(0,0), breaks = "week", date_labels = "%d %b") +
  scale_fill_manual(values=c("#0D0887FF","#2D0594FF","#44039EFF","#5901A5FF","#6F00A8FF",
                             "#8305A7FF","#9512A1FF","#A72197FF","#B6308BFF","#C5407EFF",
                             "#D14E72FF","#DD5E66FF","#E76E5BFF","#EF7F4FFF","#F79044FF",
                             "#FBA238FF","#FEB72DFF","#FDCB26FF","#F7E225FF","#F0F921FF"),na.value = "grey90")+
  theme_grey(base_size=10)+
  theme(plot.title=element_text(colour="#444444",hjust=0,size=16,family = "Brown"),
        plot.subtitle = element_text(colour="#444444",hjust=0,size=12,family = "Brown"),
        legend.position="right",legend.direction="vertical",
        legend.title=element_text(colour=textcol),
        legend.margin=margin(grid::unit(0,"cm")),
        legend.text=element_text(colour=textcol,size=7,family = "Brown"),
        legend.key.height=grid::unit(0.2,"cm"),
        legend.key.width=grid::unit(0.2,"cm"),
        axis.text.x=element_text(size=8,colour=textcol,family = "Brown", angle = 50, hjust = 1),
        axis.text.y=element_text(size=8, vjust=0.2,colour=textcol,family = "Brown"),
        axis.ticks=element_line(size=0.4),
        plot.background=element_blank(),
        panel.border=element_blank())
        #plot.margin=margin(0.7,0.4,0.1,0.2,"cm")
        

p2

```

